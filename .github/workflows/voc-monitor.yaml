name: Monitor Nextstrain Clade Designations
on:
  schedule:
    # Run daily at 9:00 AM UTC (you can adjust this time)
    - cron: '0 8 * * *'
  workflow_dispatch: # Allow manual triggering
    inputs:
      force_check:
        description: 'Force check even if no changes detected'
        required: false
        default: false
        type: boolean
  push:
    branches:
      - feat/nextclade_monitor
jobs:
  check-clades:
    runs-on: ubuntu-latest
    permissions:
      contents: write # To commit changes to the repository
      issues: write # To create issues
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Download current clade_hierarchy.tsv from Nextstrain ncov repository
        run: |
          curl -s -o current_clade_hierarchy.tsv "https://raw.githubusercontent.com/nextstrain/ncov/master/defaults/clade_hierarchy.tsv"
      - name: Download clade display names and emergence dates
        run: |
          curl -s -o clade_display_names.yml "https://raw.githubusercontent.com/nextstrain/ncov/master/defaults/clade_display_names.yml"
          curl -s -o clade_emergence_dates.tsv "https://raw.githubusercontent.com/nextstrain/ncov/master/defaults/clade_emergence_dates.tsv"
      - name: Create tracking directory if it doesn't exist
        run: |
          mkdir -p .github/nextstrain-monitor
      - name: Check for clade changes and create issue if needed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FORCE_CHECK: ${{ github.event.inputs.force_check }}
        run: |
            python << 'EOF'
            import os
            import requests
            from datetime import datetime
            import sys
            import yaml

            # Configuration
            STORED_FILE = '.github/nextstrain-monitor/previous_clade_hierarchy.tsv'
            CURRENT_FILE = 'current_clade_hierarchy.tsv'
            DISPLAY_NAMES_FILE = 'clade_display_names.yml'
            EMERGENCE_DATES_FILE = 'clade_emergence_dates.tsv'
            GITHUB_TOKEN = os.environ['GITHUB_TOKEN']
            REPO = os.environ['GITHUB_REPOSITORY']
            FORCE_CHECK = os.environ.get('FORCE_CHECK', 'false').lower() == 'true'

            def read_clades_from_hierarchy(filepath):
                """Read clade hierarchy file and return set of unique clades"""
                try:
                    clades = set()
                    with open(filepath, 'r') as f:
                        for line in f:
                            line = line.strip()
                            # Skip empty lines and comments
                            if line and not line.startswith('#'):
                                # Handle TSV format - take first column as clade name
                                if '\t' in line:
                                    clade = line.split('\t')[0].strip()
                                else:
                                    # If no tabs, assume whole line is clade name
                                    clade = line.strip()

                                if clade:
                                    clades.add(clade)

                    return clades

                except Exception as e:
                    print(f"Error reading {filepath}: {e}")
                    return set()

            def load_clade_display_names(filepath):
                """Load clade display names from YAML file"""
                try:
                    with open(filepath, 'r') as f:
                        return yaml.safe_load(f) or {}
                except Exception as e:
                    print(f"Warning: Could not load display names from {filepath}: {e}")
                    return {}

            def load_clade_emergence_dates(filepath):
                """Load clade emergence dates from TSV file"""
                try:
                    emergence_dates = {}
                    with open(filepath, 'r') as f:
                        # Skip header line
                        next(f, None)
                        for line in f:
                            line = line.strip()
                            if line and '\t' in line:
                                parts = line.split('\t')
                                if len(parts) >= 2:
                                    clade = parts[0].strip()
                                    date = parts[1].strip()
                                    emergence_dates[clade] = date
                    return emergence_dates
                except Exception as e:
                    print(f"Warning: Could not load emergence dates from {filepath}: {e}")
                    return {}

            def get_clade_info(clade, display_names, emergence_dates):
                """Get enriched information for a clade"""
                display_name = display_names.get(clade, clade)
                emergence_date = emergence_dates.get(clade, "Unknown")
                
                # Format emergence date nicely
                if emergence_date != "Unknown":
                    try:
                        date_obj = datetime.strptime(emergence_date, "%Y-%m-%d")
                        formatted_date = date_obj.strftime("%B %Y")
                    except:
                        formatted_date = emergence_date
                else:
                    formatted_date = "Unknown"
                
                return {
                    'clade': clade,
                    'display_name': display_name,
                    'emergence_date': emergence_date,
                    'formatted_date': formatted_date
                }

            def create_github_issue(title, body, labels=None, assignees=None):
                """Create a GitHub issue"""
                if labels is None:
                    labels = ['nextstrain', 'clade-designation', 'automated']
                if assignees is None:
                    assignees = ['gordonkoehn']

                url = f"https://api.github.com/repos/{REPO}/issues"
                headers = {
                    'Authorization': f'token {GITHUB_TOKEN}',
                    'Accept': 'application/vnd.github.v3+json'
                }

                data = {
                    'title': title,
                    'body': body,
                    'labels': labels,
                    'assignees': assignees
                }

                try:
                    response = requests.post(url, headers=headers, json=data)
                    response.raise_for_status()
                    issue_data = response.json()
                    print(f"‚úÖ Created issue #{issue_data['number']}: {title}")
                    return issue_data
                except Exception as e:
                    print(f"‚ùå Error creating issue: {e}")
                    return None

            # Main logic
            print("üîç Checking for new Nextstrain clade designations...")

            # Load supplementary data
            print("üì• Loading clade display names and emergence dates...")
            display_names = load_clade_display_names(DISPLAY_NAMES_FILE)
            emergence_dates = load_clade_emergence_dates(EMERGENCE_DATES_FILE)
            print(f"üìÑ Loaded {len(display_names)} display names and {len(emergence_dates)} emergence dates")

            # Read current clades
            current_clades = read_clades_from_hierarchy(CURRENT_FILE)
            print(f"üìä Found {len(current_clades)} clades in current file")
            if current_clades:
                print(f"üî§ Current clades: {', '.join(sorted(current_clades))}")

            # Read previous clades (if exists)
            previous_clades = set()
            if os.path.exists(STORED_FILE):
                previous_clades = read_clades_from_hierarchy(STORED_FILE)
                print(f"üìã Found {len(previous_clades)} clades in previous file")
            else:
                print("üìÑ No previous clades file found - this is the first run")

            # Find new clades
            new_clades = current_clades - previous_clades

            if new_clades:
                print(f"üÜï Detected {len(new_clades)} new clade(s): {', '.join(sorted(new_clades))}")

                # Get enriched information for new clades
                new_clade_info = []
                for clade in sorted(new_clades):
                    info = get_clade_info(clade, display_names, emergence_dates)
                    new_clade_info.append(info)
                    print(f"üìã {clade} -> {info['display_name']} (emerged: {info['formatted_date']})")

                # Create issue for new clades
                clade_list = [info['display_name'] for info in new_clade_info]
                if len(clade_list) == 1:
                    title = f"New Nextstrain Clade Designation Detected: {clade_list[0]}"
                else:
                    title = f"New Nextstrain Clade Designations Detected: {', '.join(clade_list)}"

                # Build detailed body
                current_date = datetime.now().strftime("%B %d, %Y")
                body = "# üß¨ New Nextstrain Clade Designation Alert\n\n"
                body += "‚ö†Ô∏è **Action Required**: A new clade has been assigned by Nextstrain, consider adding it to the wastewater monitoring.\n\n"
                body += f"**Date Detected:** {current_date}\n"
                body += "**Source:** [nextstrain/ncov](https://github.com/nextstrain/ncov/blob/master/defaults/clade_hierarchy.tsv)\n\n"
                body += "## New Clade(s) Detected\n\n"

                for info in new_clade_info:
                    body += f"- **{info['display_name']}** (emerged: {info['formatted_date']})\n"

                body += f"\n## Summary\n\n"
                body += f"- **New Clades:** {len(new_clades)}\n"
                body += f"- **Total Clades:** {len(current_clades)}\n"
                body += f"- **Previous Total:** {len(previous_clades)}\n\n"
                body += "## About Nextstrain Clades\n\n"
                body += "Nextstrain clades are designated when a variant:\n"
                body += "- Reaches a frequency of 20% globally at any time point\n"
                body += "- Is at least 2 mutations away from its parent major clade\n"
                body += "- Shows significant geographic spread\n\n"
                body += "Clade names consist of the year they emerged and the next available letter in the alphabet (e.g., 19A, 20A, 21A, etc.).\n\n"
                body += "## Resources\n\n"
                body += "- üî¨ [Nextstrain SARS-CoV-2 Build](https://nextstrain.org/ncov/global)\n"
                body += "- üìñ [Clade Naming Documentation](https://docs.nextstrain.org/projects/ncov/en/latest/reference/naming_clades.html)\n"
                body += "- üìÇ [Source File](https://github.com/nextstrain/ncov/blob/master/defaults/clade_hierarchy.tsv)\n"
                body += "- üîç [Detailed Clade Definitions](https://github.com/nextstrain/ncov/blob/master/defaults/clades.tsv)\n"
                body += "- üìÑ [Display Names](https://github.com/nextstrain/ncov/blob/master/defaults/clade_display_names.yml)\n"
                body += "- üìÖ [Emergence Dates](https://github.com/nextstrain/ncov/blob/master/defaults/clade_emergence_dates.tsv)\n\n"
                body += "---\n"
                body += "*This issue was automatically created by the Nextstrain Clade Monitor action.*\n"

                # Create the issue
                issue = create_github_issue(title, body)

                if issue:
                    print(f"üìã Issue created successfully: {issue['html_url']}")

            elif FORCE_CHECK:
                print("üîÑ Force check enabled - creating informational issue")
                title = f"Nextstrain Clade Monitor - Manual Check ({datetime.now().strftime('%Y-%m-%d')})"
                
                body = "# üß¨ Nextstrain Clade Monitor - Manual Check\n\n"
                body += f"**Date:** {datetime.now().strftime('%B %d, %Y at %H:%M UTC')}\n\n"
                body += "This is a manually triggered check of the Nextstrain clade designations.\n\n"
                body += "## Current Status\n\n"
                body += f"- **Total Clades:** {len(current_clades)}\n"
                body += "- **New Clades:** None detected\n\n"
                body += "## Resources\n\n"
                body += "- üî¨ [Nextstrain SARS-CoV-2 Build](https://nextstrain.org/ncov/global)\n"
                body += "- üìÇ [Source File](https://github.com/nextstrain/ncov/blob/master/defaults/clade_hierarchy.tsv)\n"
                body += "- üìÑ [Display Names](https://github.com/nextstrain/ncov/blob/master/defaults/clade_display_names.yml)\n"
                body += "- üìÖ [Emergence Dates](https://github.com/nextstrain/ncov/blob/master/defaults/clade_emergence_dates.tsv)\n\n"
                body += "---\n"
                body += "*This issue was manually triggered via the GitHub Actions workflow.*\n"
                create_github_issue(title, body, ['nextstrain', 'manual-check', 'automated'])
            else:
                print("‚úÖ No new clades detected")

            # Always update the stored file for next comparison
            os.makedirs(os.path.dirname(STORED_FILE), exist_ok=True)
            with open(STORED_FILE, 'w') as f:
                with open(CURRENT_FILE, 'r') as current:
                    f.write(current.read())

            print("üíæ Updated stored clades file for next comparison")

            # Output summary
            print("")
            print("üìä Summary:")
            print(f"- Current clades: {len(current_clades)}")
            print(f"- Previous clades: {len(previous_clades)}")
            print(f"- New clades: {len(new_clades)}")
            print("")

            if new_clades:
                print("üÜï New clades detected:")
                for clade in sorted(new_clades):
                    info = get_clade_info(clade, display_names, emergence_dates)
                    print(f"  ‚Ä¢ {info['display_name']} (emerged: {info['formatted_date']})")

            EOF
      - name: Commit updated tracking file
        if: always()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .github/nextstrain-monitor/
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update Nextstrain clade tracking data [skip ci]" || echo "Nothing to commit"
            git push || echo "Nothing to push"
          fi
      - name: Cleanup temporary files
        if: always()
        run: |-
          rm -f current_clade_hierarchy.tsv clade_display_names.yml clade_emergence_dates.tsv