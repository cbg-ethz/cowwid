Updated on 27 Jan 2026 kkirschen

# Quick info
## Running the script
- adapt and run the bash script:
`/cluster/project/pangolin/resources/cowwid/json_parser_for_variant_curve_stitching/scripts/run_stitching.sh`

# Code Documentation

## Stitch and Align Variant Time Series JSON Files
===============================================

### Purpose
-------
This script stitches two nested JSON datasets containing time series data
(e.g. SARS-CoV-2 variant proportions) by location and variant, while enforcing
a strict alignment of time points.

The output guarantees that, within each location, all variants share the
same date grid and can therefore be compared, plotted, or diffed reliably.

### Input Data Model
----------------
The input JSON files are expected to have the structure:

{
  "Location": {
    "Variant": {
      "timeseriesSummary": [
        {
          "date": "YYYY-MM-DD",
          "proportion": float,
          "proportionLower": float,
          "proportionUpper": float
        },
        ...
      ]
    },
    ...
  },
  ...
}

### Core Stitching Rules
-------------------
1. Stitching cutoff (per location):
   - The stitch date for a location is the earliest date present in the NEW file
     for that location.
   - OLD data is kept only for dates strictly before the stitch date.
   - NEW data is kept for all dates.
   - If a date exists in both OLD and NEW, NEW always takes precedence.

2. Date identity:
   - Dates are treated as the primary key of the time series.
   - Internally, time series are indexed by date to avoid order-dependent logic
     and to enforce one entry per date.

3. Shared date grid (critical invariant):
   - For each location, a shared date grid is constructed as the union of all
     dates observed in OLD and NEW across all variants.
   - Every variant at that location is expanded to this grid.
   - Missing dates are filled with zero-valued entries:
       proportion = 0
       proportionLower = 0
       proportionUpper = 0

4. Newly introduced variants:
   - Variants that appear only in the NEW file are back-filled with zeros for
     all earlier dates in the location’s grid.
   - This ensures all variants align in time, even if they emerge later.

5. Locations present in only one file:
   - If a location exists only in OLD or only in NEW, its data is preserved,
     but the shared date grid invariant is still enforced within that location.

### Design Rationale
----------------
- Lists are unsuitable for time series logic because their index has no
  semantic meaning. Dates are therefore treated as explicit keys.
- Enforcing a shared date grid avoids downstream issues in plotting,
  statistical comparison, and DeepDiff-based validation.
- Zero-filling missing dates makes variant curves directly comparable and
  preserves total alignment across variants.

### Output Guarantees
-----------------
- All timeseriesSummary lists are:
    - sorted by date
    - unique by date
    - identical in length across variants within a location
- The output JSON is deterministic and stable under repeated stitching.

### Typical Use
-----------
    python stitch_variants.py \
        --old older.json \
        --new newer.json \
        --output stitched.json


## Testing and Validation
----------------------
The stitching logic was validated using a controlled real-world scenario
based on sequential variant introduction.

Test scenario:
1. A reference JSON file was generated by running Lollipop once on combined
   November and December batches, where the new variant BA.3.2 was introduced
   starting from 2025-12-01.

2. Two separate JSON files were then generated:
   - one from November batches only (without BA.3.2),
   - one from December batches only (with BA.3.2).

3. These two files were used as input to the stitching script
   (November → OLD, December → NEW).

4. The stitched output was compared against the reference JSON from step 1.

Validation method:
- A dedicated comparison script
  (/cluster/project/pangolin/resources/cowwid/json_parser_for_variant_curve_stitching/scripts/testing_script_compare_json_file_format.py)
  was used to:
    - compare the stitched output to the reference file,
    - verify identical date grids across variants per location,
    - confirm equal lengths of timeseriesSummary lists,
    - inspect remaining differences using DeepDiff.

Outcome:
- All variants within each location shared the same date grid.
- Newly introduced variants (BA.3.2) were correctly zero-filled before
  their introduction date.
- The stitched output matched the reference output structurally and
  semantically, confirming correct stitching behavior.

Test case files created:
/cluster/project/pangolin/research/NEXUS/20260126_json_parser

### Running the testing script:
Documentation of deepdiff: https://zepworks.com/deepdiff/current/diff.html
``` 
conda create -n deepdiff-env python=3.10
conda activate deepdiff-env
python -m pip install deepdiff
python /cluster/project/pangolin/resources/cowwid/json_parser_for_variant_curve_stitching/scripts/testing_script_compare_json_file_format.py
```